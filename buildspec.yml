version: 0.2

phases:
  install:
    commands:
#      - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
#      - unzip awscliv2.zip
#      - ls -l /root/.pyenv/shims/aws
#      - ./aws/install --bin-dir /root/.pyenv/shims --install-dir /usr/local/aws-cli --update
  pre_build:
    commands:
      - echo No Pre Build phase
  build:
    commands:
      - echo Build started on `date`
      - LambdaCurrentVersion=$(echo $(aws lambda get-alias --function-name 2175051-test-task1-lambda --name prod | grep FunctionVersion | tail -1 |tr -cd 0-9))
      - "SFCurrentVersion=$(echo $(aws stepfunctions describe-state-machine-alias --state-machine-alias-arn arn:aws:states:ap-northeast-1:477460359712:stateMachine:2175051-test-MyStateMachine:prod | grep stateMachineVersionArn | tail -1 | cut -d : -f 9 | tr -cd 0-9))"
      - zip -r lambda.zip ./lambda_function.py
      - aws s3 ls
      - aws lambda update-function-code --function-name 2175051-test-task1-lambda --zip-file fileb://lambda.zip
      - sleep 10
      - "aws stepfunctions update-state-machine --state-machine-arn arn:aws:states:ap-northeast-1:477460359712:stateMachine:2175051-test-MyStateMachine --definition file://definition.json"
      - sleep 10
  post_build:
    commands:
      - echo Build completed on `date`
      - ls
      - aws lambda publish-version --function-name 2175051-test-task1-lambda --description "update version"
      - LambdaTargetVersion=$(echo $(aws lambda list-versions-by-function --function-name 2175051-test-task1-lambda | grep Version | tail -1 | tr -cd 0-9))
      - echo $LambdaCurrentVersion
      - echo $LambdaTargetVersion
      - aws lambda update-alias --function-name 2175051-test-task1-lambda --name prod --function-version $LambdaTargetVersion
      - aws lambda delete-function --function-name 2175051-test-task1-lambda --qualifier $LambdaCurrentVersion
      - "aws stepfunctions publish-state-machine-version --state-machine-arn arn:aws:states:ap-northeast-1:477460359712:stateMachine:2175051-test-MyStateMachine --description 'update version'"
      - "SFTargetVersion=$(echo $(aws stepfunctions list-state-machine-versions --state-machine-arn arn:aws:states:ap-northeast-1:477460359712:stateMachine:2175051-test-MyStateMachine | grep stateMachineVersionArn | cut -d : -f 9 | tr -cd 0-9))"
      - echo $SFCurrentVersion
      - echo $SFTargetVersion
      - "aws stepfunctions update-state-machine-alias --state-machine-alias-arn arn:aws:states:ap-northeast-1:477460359712:stateMachine:2175051-test-MyStateMachine:prod --version  $TargetVersion"
      - "aws stepfunctions delete-state-machine --state-machine-arn arn:aws:states:ap-northeast-1:477460359712:stateMachine:2175051-test-MyStateMachine"